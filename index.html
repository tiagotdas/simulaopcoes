<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Estratégias com Opções</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="bg-gray-900 text-white p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-blue-400">Simulador de Opções</h1>
            <p class="text-gray-400 mt-2">Teste estratégias de Venda Coberta, Venda de Put e Travas de Crédito.</p>
        </header>

        <!-- Abas de Navegação -->
        <div class="mb-6">
            <div class="border-b border-gray-700">
                <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                    <button id="tab-covered-call" class="tab-btn tab-active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Venda Coberta</button>
                    <button id="tab-cash-secured-put" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500">Venda de Put</button>
                    <button id="tab-bear-call-spread" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500">Trava de Baixa</button>
                    <button id="tab-bull-put-spread" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500">Trava de Alta</button>
                </nav>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Coluna de Inputs -->
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <!-- Formulário Venda Coberta (Covered Call) -->
                <div id="form-covered-call" class="strategy-form">
                    <h2 class="text-xl font-semibold mb-4 text-blue-300">Venda Coberta de Call</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="cc-ticker" class="block text-sm font-medium text-gray-300 mb-1">Ativo (Ticker)</label>
                            <input type="text" id="cc-ticker" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" value="PETR4">
                        </div>
                        <div>
                            <label for="cc-stock-price" class="block text-sm font-medium text-gray-300 mb-1">Preço da Ação (R$)</label>
                            <input type="number" id="cc-stock-price" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" value="35.00" step="0.01">
                        </div>
                        <div>
                            <label for="cc-strike" class="block text-sm font-medium text-gray-300 mb-1">Strike da Call (R$)</label>
                            <input type="number" id="cc-strike" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" value="36.00" step="0.01">
                        </div>
                        <div>
                            <label for="cc-premium" class="block text-sm font-medium text-gray-300 mb-1">Prêmio Recebido (R$)</label>
                            <input type="number" id="cc-premium" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" value="1.20" step="0.01">
                        </div>
                        <div>
                            <label for="cc-quantity" class="block text-sm font-medium text-gray-300 mb-1">Quantidade (Contratos)</label>
                            <input type="number" id="cc-quantity" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" value="1" min="1">
                        </div>
                    </div>
                </div>

                <!-- Formulário Venda de Put (Cash-Secured Put) -->
                <div id="form-cash-secured-put" class="strategy-form hidden">
                    <h2 class="text-xl font-semibold mb-4 text-blue-300">Venda de Put (Segura em Caixa)</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="csp-ticker" class="block text-sm font-medium text-gray-300 mb-1">Ativo (Ticker)</label>
                            <input type="text" id="csp-ticker" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" value="VALE3">
                        </div>
                        <div>
                            <label for="csp-stock-price" class="block text-sm font-medium text-gray-300 mb-1">Preço da Ação (R$)</label>
                            <input type="number" id="csp-stock-price" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" value="65.00" step="0.01">
                        </div>
                        <div>
                            <label for="csp-strike" class="block text-sm font-medium text-gray-300 mb-1">Strike da Put (R$)</label>
                            <input type="number" id="csp-strike" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" value="63.00" step="0.01">
                        </div>
                        <div>
                            <label for="csp-premium" class="block text-sm font-medium text-gray-300 mb-1">Prêmio Recebido (R$)</label>
                            <input type="number" id="csp-premium" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" value="1.50" step="0.01">
                        </div>
                         <div>
                            <label for="csp-quantity" class="block text-sm font-medium text-gray-300 mb-1">Quantidade (Contratos)</label>
                            <input type="number" id="csp-quantity" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" value="1" min="1">
                        </div>
                    </div>
                </div>

                <!-- Formulário Trava de Baixa (Bear Call Spread) -->
                <div id="form-bear-call-spread" class="strategy-form hidden">
                    <h2 class="text-xl font-semibold mb-4 text-blue-300">Trava de Baixa com Calls</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="bcs-ticker" class="block text-sm font-medium text-gray-300 mb-1">Ativo (Ticker)</label>
                            <input type="text" id="bcs-ticker" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" value="ITUB4">
                        </div>
                        <div>
                            <label for="bcs-stock-price" class="block text-sm font-medium text-gray-300 mb-1">Preço da Ação (R$)</label>
                            <input type="number" id="bcs-stock-price" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" value="32.00" step="0.01">
                        </div>
                        <div>
                            <label for="bcs-short-strike" class="block text-sm font-medium text-gray-300 mb-1">Strike Vendido (R$)</label>
                            <input type="number" id="bcs-short-strike" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" value="33.00" step="0.01">
                        </div>
                        <div>
                            <label for="bcs-short-premium" class="block text-sm font-medium text-gray-300 mb-1">Prêmio Recebido (R$)</label>
                            <input type="number" id="bcs-short-premium" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" value="0.80" step="0.01">
                        </div>
                        <div>
                            <label for="bcs-long-strike" class="block text-sm font-medium text-gray-300 mb-1">Strike Comprado (R$)</label>
                            <input type="number" id="bcs-long-strike" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" value="34.00" step="0.01">
                        </div>
                        <div>
                            <label for="bcs-long-premium" class="block text-sm font-medium text-gray-300 mb-1">Prêmio Pago (R$)</label>
                            <input type="number" id="bcs-long-premium" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" value="0.30" step="0.01">
                        </div>
                        <div class="sm:col-span-2">
                            <label for="bcs-quantity" class="block text-sm font-medium text-gray-300 mb-1">Quantidade (Contratos)</label>
                            <input type="number" id="bcs-quantity" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" value="1" min="1">
                        </div>
                    </div>
                </div>

                <!-- Formulário Trava de Alta (Bull Put Spread) -->
                <div id="form-bull-put-spread" class="strategy-form hidden">
                    <h2 class="text-xl font-semibold mb-4 text-blue-300">Trava de Alta com Puts</h2>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="bps-ticker" class="block text-sm font-medium text-gray-300 mb-1">Ativo (Ticker)</label>
                            <input type="text" id="bps-ticker" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" value="BBDC4">
                        </div>
                        <div>
                            <label for="bps-stock-price" class="block text-sm font-medium text-gray-300 mb-1">Preço da Ação (R$)</label>
                            <input type="number" id="bps-stock-price" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" value="13.00" step="0.01">
                        </div>
                        <div>
                            <label for="bps-short-strike" class="block text-sm font-medium text-gray-300 mb-1">Strike Vendido (R$)</label>
                            <input type="number" id="bps-short-strike" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" value="12.50" step="0.01">
                        </div>
                        <div>
                            <label for="bps-short-premium" class="block text-sm font-medium text-gray-300 mb-1">Prêmio Recebido (R$)</label>
                            <input type="number" id="bps-short-premium" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" value="0.50" step="0.01">
                        </div>
                        <div>
                            <label for="bps-long-strike" class="block text-sm font-medium text-gray-300 mb-1">Strike Comprado (R$)</label>
                            <input type="number" id="bps-long-strike" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" value="12.00" step="0.01">
                        </div>
                        <div>
                            <label for="bps-long-premium" class="block text-sm font-medium text-gray-300 mb-1">Prêmio Pago (R$)</label>
                            <input type="number" id="bps-long-premium" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" value="0.20" step="0.01">
                        </div>
                        <div class="sm:col-span-2">
                            <label for="bps-quantity" class="block text-sm font-medium text-gray-300 mb-1">Quantidade (Contratos)</label>
                            <input type="number" id="bps-quantity" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" value="1" min="1">
                        </div>
                    </div>
                </div>
                 <button id="log-trade-btn" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    Registrar Operação no Diário
                </button>
            </div>

            <!-- Coluna de Resultados e Gráfico -->
            <div>
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
                    <h3 class="text-xl font-semibold mb-4 text-blue-300">Simulação de Resultado</h3>
                    <div class="mb-4">
                        <label for="expiration-price" class="block text-sm font-medium text-gray-300 mb-1">Preço da Ação no Vencimento: <span id="expiration-price-label" class="font-bold text-blue-400">R$ 35.00</span></label>
                        <input type="range" id="expiration-price" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" min="25" max="45" step="0.1" value="35">
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <div id="pnl-card" class="bg-gray-800 p-4 rounded-lg text-center cursor-help">
                            <div class="text-sm text-gray-400">Lucro/Prejuízo</div>
                            <div id="pnl" class="text-xl font-semibold text-green-400">R$ 0,00</div>
                        </div>
                        <div id="max-profit-card" class="bg-gray-800 p-4 rounded-lg text-center cursor-help">
                            <div class="text-sm text-gray-400">Lucro Máximo</div>
                            <div id="max-profit" class="text-xl font-semibold text-green-400">R$ 0,00</div>
                        </div>
                        <div id="max-loss-card" class="bg-gray-800 p-4 rounded-lg text-center cursor-help">
                            <div class="text-sm text-gray-400">Prejuízo Máximo</div>
                            <div id="max-loss" class="text-xl font-semibold text-red-400">R$ 0,00</div>
                        </div>
                        <div id="break-even-card" class="bg-gray-800 p-4 rounded-lg text-center cursor-help">
                            <div class="text-sm text-gray-400">Break-Even</div>
                            <div id="break-even" class="text-xl font-semibold text-yellow-400">R$ 0,00</div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <canvas id="payoff-chart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Diário de Operações -->
        <div class="mt-10 bg-gray-800 p-6 rounded-lg shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-blue-300">Diário de Operações (Paper Trading)</h2>
                <button id="clear-log-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg text-sm transition duration-300">Limpar Diário</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-300">
                    <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                        <tr>
                            <th scope="col" class="px-4 py-3">Estratégia</th>
                            <th scope="col" class="px-4 py-3">Ativo</th>
                            <th scope="col" class="px-4 py-3">Parâmetros</th>
                            <th scope="col" class="px-4 py-3">Crédito Total</th>
                            <th scope="col" class="px-4 py-3">Resultado Simulado</th>
                        </tr>
                    </thead>
                    <tbody id="trade-log-body">
                       <!-- Linhas serão adicionadas via JS -->
                    </tbody>
                    <tfoot>
                        <tr class="font-semibold text-white">
                            <th scope="row" colspan="4" class="px-4 py-3 text-base text-right">Resultado Total:</th>
                            <td id="total-pnl" class="px-4 py-3 text-base">R$ 0,00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

    </div>

    <script>
    // --- VARIÁVEIS GLOBAIS ---
    let chart;
    let currentStrategy = 'covered-call';
    let tradeLog = []; // Array para armazenar as operações

    // --- ELEMENTOS DO DOM ---
    const tabs = document.querySelectorAll('.tab-btn');
    const forms = document.querySelectorAll('.strategy-form');
    const expirationPriceSlider = document.getElementById('expiration-price');
    const expirationPriceLabel = document.getElementById('expiration-price-label');
    const pnlEl = document.getElementById('pnl');
    const maxProfitEl = document.getElementById('max-profit');
    const maxLossEl = document.getElementById('max-loss');
    const breakEvenEl = document.getElementById('break-even');
    const pnlCard = document.getElementById('pnl-card');
    const maxProfitCard = document.getElementById('max-profit-card');
    const maxLossCard = document.getElementById('max-loss-card');
    const breakEvenCard = document.getElementById('break-even-card');
    const logTradeBtn = document.getElementById('log-trade-btn');
    const tradeLogBody = document.getElementById('trade-log-body');
    const totalPnlEl = document.getElementById('total-pnl');
    const clearLogBtn = document.getElementById('clear-log-btn');

    // --- FUNÇÕES DE CÁLCULO ---
    const formatCurrency = (value) => {
        const colorClass = value >= 0 ? 'text-green-400' : 'text-red-400';
        const formattedValue = `R$ ${value.toFixed(2).replace('.', ',')}`;
        return `<span class="${colorClass}">${formattedValue}</span>`;
    };

    function getPrefix(strategy) {
        switch (strategy) {
            case 'covered-call': return 'cc';
            case 'cash-secured-put': return 'csp';
            case 'bear-call-spread': return 'bcs';
            case 'bull-put-spread': return 'bps';
            default: return '';
        }
    }

    function calculateCoveredCall(stockPrice, strike, premium, quantity, expirationPrice) {
        const shares = quantity * 100;
        const stockCost = stockPrice; 
        let profitLoss;

        if (expirationPrice <= strike) {
            profitLoss = (expirationPrice - stockCost) * shares + premium * shares;
        } else {
            profitLoss = (strike - stockCost) * shares + premium * shares;
        }
        
        const maxProfit = (strike - stockCost) * shares + premium * shares;
        const maxLoss = (-stockCost * shares) + (premium * shares);
        const breakEven = stockCost - premium;

        return { profitLoss, maxProfit, maxLoss, breakEven };
    }

    function calculateCashSecuredPut(strike, premium, quantity, expirationPrice) {
        const shares = quantity * 100;
        let profitLoss;

        if (expirationPrice >= strike) {
            profitLoss = premium * shares;
        } else {
            profitLoss = (expirationPrice - strike) * shares + premium * shares;
        }
        
        const maxProfit = premium * shares;
        const maxLoss = (-strike * shares) + (premium * shares);
        const breakEven = strike - premium;

        return { profitLoss, maxProfit, maxLoss, breakEven };
    }

    function calculateBearCallSpread(shortStrike, shortPremium, longStrike, longPremium, quantity, expirationPrice) {
        const shares = quantity * 100;
        const netPremium = shortPremium - longPremium;
        let profitLoss;

        if (expirationPrice <= shortStrike) {
            profitLoss = netPremium * shares;
        } else if (expirationPrice > shortStrike && expirationPrice < longStrike) {
            profitLoss = (-(expirationPrice - shortStrike) + netPremium) * shares;
        } else {
            profitLoss = (-(longStrike - shortStrike) + netPremium) * shares;
        }

        const maxProfit = netPremium * shares;
        const maxLoss = (-(longStrike - shortStrike) + netPremium) * shares;
        const breakEven = shortStrike + netPremium;

        return { profitLoss, maxProfit, maxLoss, breakEven };
    }
    
    function calculateBullPutSpread(shortStrike, shortPremium, longStrike, longPremium, quantity, expirationPrice) {
        const shares = quantity * 100;
        const netPremium = shortPremium - longPremium;
        let profitLoss;
        
        if (expirationPrice >= shortStrike) {
            profitLoss = netPremium * shares;
        } else if (expirationPrice < shortStrike && expirationPrice > longStrike) {
            profitLoss = (expirationPrice - shortStrike + netPremium) * shares;
        } else {
            profitLoss = (-(shortStrike - longStrike) + netPremium) * shares;
        }

        const maxProfit = netPremium * shares;
        const maxLoss = (-(shortStrike - longStrike) + netPremium) * shares;
        const breakEven = shortStrike - netPremium;
        
        return { profitLoss, maxProfit, maxLoss, breakEven };
    }

    // --- FUNÇÕES DE ATUALIZAÇÃO DA UI ---
    function updateSliderAndLabel(stockPrice) {
        const min = stockPrice * 0.7;
        const max = stockPrice * 1.3;
        expirationPriceSlider.min = min;
        expirationPriceSlider.max = max;
        expirationPriceSlider.value = stockPrice;
        expirationPriceSlider.step = (max - min) / 200;
        expirationPriceLabel.textContent = `R$ ${parseFloat(stockPrice).toFixed(2)}`;
    }

    function updateTooltips(results, inputs, expirationPrice) {
        const shares = inputs.quantity * 100;
        let pnlTooltip, maxProfitTooltip, maxLossTooltip, breakEvenTooltip;

        switch (currentStrategy) {
            case 'covered-call':
                pnlTooltip = expirationPrice <= inputs.strike
                    ? `Ação não é exercida. \nResultado = (Preço Final - Preço Ação + Prêmio) * Ações \n(${expirationPrice.toFixed(2)} - ${inputs.stockPrice.toFixed(2)} + ${inputs.premium.toFixed(2)}) * ${shares} = ${results.profitLoss.toFixed(2)}`
                    : `Ação é exercida no strike. \nResultado = (Strike - Preço Ação + Prêmio) * Ações \n(${inputs.strike.toFixed(2)} - ${inputs.stockPrice.toFixed(2)} + ${inputs.premium.toFixed(2)}) * ${shares} = ${results.profitLoss.toFixed(2)}`;
                maxProfitTooltip = `Lucro máximo se a ação fechar acima do strike. \n(Strike - Preço Ação + Prêmio) * Ações \n(${inputs.strike.toFixed(2)} - ${inputs.stockPrice.toFixed(2)} + ${inputs.premium.toFixed(2)}) * ${shares} = ${results.maxProfit.toFixed(2)}`;
                maxLossTooltip = `Prejuízo se a ação cair. Teoricamente ilimitado para baixo, mas limitado a zero. \n(-Preço Ação + Prêmio) * Ações \n(-${inputs.stockPrice.toFixed(2)} + ${inputs.premium.toFixed(2)}) * ${shares} = ${results.maxLoss.toFixed(2)}`;
                breakEvenTooltip = `Preço da ação no qual a operação zera. \nPreço Ação - Prêmio \n${inputs.stockPrice.toFixed(2)} - ${inputs.premium.toFixed(2)} = ${results.breakEven.toFixed(2)}`;
                break;
            case 'cash-secured-put':
                pnlTooltip = expirationPrice >= inputs.strike
                    ? `Opção vira pó. \nResultado = Prêmio * Ações \n${inputs.premium.toFixed(2)} * ${shares} = ${results.profitLoss.toFixed(2)}`
                    : `Obrigado a comprar a ação no strike. \nResultado = (Preço Final - Strike + Prêmio) * Ações \n(${expirationPrice.toFixed(2)} - ${inputs.strike.toFixed(2)} + ${inputs.premium.toFixed(2)}) * ${shares} = ${results.profitLoss.toFixed(2)}`;
                maxProfitTooltip = `Lucro máximo é o prêmio, se a ação fechar acima do strike. \nPrêmio * Ações \n${inputs.premium.toFixed(2)} * ${shares} = ${results.maxProfit.toFixed(2)}`;
                maxLossTooltip = `Prejuízo se a ação cair abaixo do break-even. \n(-Strike + Prêmio) * Ações \n(-${inputs.strike.toFixed(2)} + ${inputs.premium.toFixed(2)}) * ${shares} = ${results.maxLoss.toFixed(2)}`;
                breakEvenTooltip = `Preço da ação no qual a operação zera. \nStrike - Prêmio \n${inputs.strike.toFixed(2)} - ${inputs.premium.toFixed(2)} = ${results.breakEven.toFixed(2)}`;
                break;
            case 'bear-call-spread':
                const bcsNetPremium = inputs.shortPremium - inputs.longPremium;
                maxProfitTooltip = `Lucro máximo é o crédito recebido, se a ação fechar abaixo do strike vendido (${inputs.shortStrike.toFixed(2)}). \nCrédito Líquido * Ações \n${bcsNetPremium.toFixed(2)} * ${shares} = ${results.maxProfit.toFixed(2)}`;
                maxLossTooltip = `Prejuízo máximo é travado se a ação fechar acima do strike comprado (${inputs.longStrike.toFixed(2)}). \n(Strike Vendido - Strike Comprado + Crédito) * Ações \n(${inputs.shortStrike.toFixed(2)} - ${inputs.longStrike.toFixed(2)} + ${bcsNetPremium.toFixed(2)}) * ${shares} = ${results.maxLoss.toFixed(2)}`;
                breakEvenTooltip = `Ponto de equilíbrio da operação. \nStrike Vendido + Crédito Líquido \n${inputs.shortStrike.toFixed(2)} + ${bcsNetPremium.toFixed(2)} = ${results.breakEven.toFixed(2)}`;
                pnlTooltip = `O resultado depende do preço final em relação aos strikes. O lucro é máximo abaixo de ${inputs.shortStrike.toFixed(2)} e o prejuízo é máximo acima de ${inputs.longStrike.toFixed(2)}.`;
                break;
            case 'bull-put-spread':
                const bpsNetPremium = inputs.shortPremium - inputs.longPremium;
                maxProfitTooltip = `Lucro máximo é o crédito recebido, se a ação fechar acima do strike vendido (${inputs.shortStrike.toFixed(2)}). \nCrédito Líquido * Ações \n${bpsNetPremium.toFixed(2)} * ${shares} = ${results.maxProfit.toFixed(2)}`;
                maxLossTooltip = `Prejuízo máximo é travado se a ação fechar abaixo do strike comprado (${inputs.longStrike.toFixed(2)}). \n(Strike Comprado - Strike Vendido + Crédito) * Ações \n(${inputs.longStrike.toFixed(2)} - ${inputs.shortStrike.toFixed(2)} + ${bpsNetPremium.toFixed(2)}) * ${shares} = ${results.maxLoss.toFixed(2)}`;
                breakEvenTooltip = `Ponto de equilíbrio da operação. \nStrike Vendido - Crédito Líquido \n${inputs.shortStrike.toFixed(2)} - ${bpsNetPremium.toFixed(2)} = ${results.breakEven.toFixed(2)}`;
                pnlTooltip = `O resultado depende do preço final em relação aos strikes. O lucro é máximo acima de ${inputs.shortStrike.toFixed(2)} e o prejuízo é máximo abaixo de ${inputs.longStrike.toFixed(2)}.`;
                break;
        }
        pnlCard.title = pnlTooltip;
        maxProfitCard.title = maxProfitTooltip;
        maxLossCard.title = maxLossTooltip;
        breakEvenCard.title = breakEvenTooltip;
    }

    function updateUI() {
        const expirationPrice = parseFloat(expirationPriceSlider.value);
        expirationPriceLabel.textContent = `R$ ${expirationPrice.toFixed(2)}`;

        let results;
        const inputs = getInputs();

        if (!inputs) return;

        switch (currentStrategy) {
            case 'covered-call':
                results = calculateCoveredCall(inputs.stockPrice, inputs.strike, inputs.premium, inputs.quantity, expirationPrice);
                break;
            case 'cash-secured-put':
                results = calculateCashSecuredPut(inputs.strike, inputs.premium, inputs.quantity, expirationPrice);
                break;
            case 'bear-call-spread':
                results = calculateBearCallSpread(inputs.shortStrike, inputs.shortPremium, inputs.longStrike, inputs.longPremium, inputs.quantity, expirationPrice);
                break;
            case 'bull-put-spread':
                results = calculateBullPutSpread(inputs.shortStrike, inputs.shortPremium, inputs.longStrike, inputs.longPremium, inputs.quantity, expirationPrice);
                break;
        }

        pnlEl.innerHTML = formatCurrency(results.profitLoss);
        maxProfitEl.innerHTML = formatCurrency(results.maxProfit);
        maxLossEl.innerHTML = formatCurrency(results.maxLoss);
        breakEvenEl.innerHTML = `R$ ${results.breakEven.toFixed(2).replace('.', ',')}`;
        
        updateTooltips(results, inputs, expirationPrice);
        updateChart();
    }
    
    function getInputs() {
        const prefix = getPrefix(currentStrategy);
        const quantity = parseFloat(document.getElementById(`${prefix}-quantity`)?.value) || 1;

        switch (currentStrategy) {
            case 'covered-call':
                return {
                    ticker: document.getElementById('cc-ticker').value,
                    stockPrice: parseFloat(document.getElementById('cc-stock-price').value),
                    strike: parseFloat(document.getElementById('cc-strike').value),
                    premium: parseFloat(document.getElementById('cc-premium').value),
                    quantity: quantity
                };
            case 'cash-secured-put':
                return {
                    ticker: document.getElementById('csp-ticker').value,
                    stockPrice: parseFloat(document.getElementById('csp-stock-price').value),
                    strike: parseFloat(document.getElementById('csp-strike').value),
                    premium: parseFloat(document.getElementById('csp-premium').value),
                    quantity: quantity
                };
            case 'bear-call-spread':
                 return {
                    ticker: document.getElementById('bcs-ticker').value,
                    stockPrice: parseFloat(document.getElementById('bcs-stock-price').value),
                    shortStrike: parseFloat(document.getElementById('bcs-short-strike').value),
                    shortPremium: parseFloat(document.getElementById('bcs-short-premium').value),
                    longStrike: parseFloat(document.getElementById('bcs-long-strike').value),
                    longPremium: parseFloat(document.getElementById('bcs-long-premium').value),
                    quantity: quantity
                };
            case 'bull-put-spread':
                 return {
                    ticker: document.getElementById('bps-ticker').value,
                    stockPrice: parseFloat(document.getElementById('bps-stock-price').value),
                    shortStrike: parseFloat(document.getElementById('bps-short-strike').value),
                    shortPremium: parseFloat(document.getElementById('bps-short-premium').value),
                    longStrike: parseFloat(document.getElementById('bps-long-strike').value),
                    longPremium: parseFloat(document.getElementById('bps-long-premium').value),
                    quantity: quantity
                };
        }
    }
    
    // --- LÓGICA DO GRÁFICO ---
    function updateChart() {
        const inputs = getInputs();
        if (!inputs) return;
        const minPrice = parseFloat(expirationPriceSlider.min);
        const maxPrice = parseFloat(expirationPriceSlider.max);
        
        const labels = [];
        const data = [];
        
        for (let p = minPrice; p <= maxPrice; p += (maxPrice - minPrice) / 50) {
            labels.push(p.toFixed(2));
            let result;
            switch (currentStrategy) {
                case 'covered-call':
                    result = calculateCoveredCall(inputs.stockPrice, inputs.strike, inputs.premium, inputs.quantity, p);
                    break;
                case 'cash-secured-put':
                    result = calculateCashSecuredPut(inputs.strike, inputs.premium, inputs.quantity, p);
                    break;
                case 'bear-call-spread':
                    result = calculateBearCallSpread(inputs.shortStrike, inputs.shortPremium, inputs.longStrike, inputs.longPremium, inputs.quantity, p);
                    break;
                case 'bull-put-spread':
                    result = calculateBullPutSpread(inputs.shortStrike, inputs.shortPremium, inputs.longStrike, inputs.longPremium, inputs.quantity, p);
                    break;
            }
            data.push(result.profitLoss.toFixed(2));
        }

        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.data.datasets[0].borderColor = data.map(v => v >= 0 ? 'rgba(74, 222, 128, 1)' : 'rgba(248, 113, 113, 1)');
        chart.update();
    }

    // --- LÓGICA DO DIÁRIO DE OPERAÇÕES ---
    function saveTrades() {
        localStorage.setItem('optionsSimulatorTrades', JSON.stringify(tradeLog));
    }

    function addTradeToTable(trade) {
        const newRow = document.createElement('tr');
        newRow.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-600';
        newRow.innerHTML = `
            <td class="px-4 py-3">${trade.strategyName}</td>
            <td class="px-4 py-3 font-medium text-white">${trade.ticker.toUpperCase()}</td>
            <td class="px-4 py-3">${trade.params}</td>
            <td class="px-4 py-3">${formatCurrency(trade.credit)}</td>
            <td class="px-4 py-3">${formatCurrency(trade.profitLoss)}</td>
        `;
        tradeLogBody.appendChild(newRow);
    }

    function updateTotalPnl() {
        const total = tradeLog.reduce((acc, trade) => acc + trade.profitLoss, 0);
        totalPnlEl.innerHTML = formatCurrency(total);
    }

    function loadTrades() {
        const savedTrades = localStorage.getItem('optionsSimulatorTrades');
        if (savedTrades) {
            tradeLog = JSON.parse(savedTrades);
            tradeLogBody.innerHTML = ''; // Limpa a tabela antes de carregar
            tradeLog.forEach(trade => addTradeToTable(trade));
            updateTotalPnl();
        }
    }

    function clearLog() {
        tradeLog = [];
        tradeLogBody.innerHTML = '';
        saveTrades();
        updateTotalPnl();
    }
    
    function logTrade() {
        const inputs = getInputs();
        if (!inputs) return;
        const expirationPrice = parseFloat(expirationPriceSlider.value);
        let results, strategyName, params, credit;

        switch (currentStrategy) {
            case 'covered-call':
                results = calculateCoveredCall(inputs.stockPrice, inputs.strike, inputs.premium, inputs.quantity, expirationPrice);
                strategyName = "Venda Coberta";
                params = `Strike: ${inputs.strike.toFixed(2)}`;
                credit = inputs.premium * 100 * inputs.quantity;
                break;
            case 'cash-secured-put':
                results = calculateCashSecuredPut(inputs.strike, inputs.premium, inputs.quantity, expirationPrice);
                strategyName = "Venda de Put";
                params = `Strike: ${inputs.strike.toFixed(2)}`;
                credit = inputs.premium * 100 * inputs.quantity;
                break;
            case 'bear-call-spread':
                results = calculateBearCallSpread(inputs.shortStrike, inputs.shortPremium, inputs.longStrike, inputs.longPremium, inputs.quantity, expirationPrice);
                strategyName = "Trava de Baixa";
                params = `Strikes: ${inputs.shortStrike.toFixed(2)}/${inputs.longStrike.toFixed(2)}`;
                credit = (inputs.shortPremium - inputs.longPremium) * 100 * inputs.quantity;
                break;
            case 'bull-put-spread':
                results = calculateBullPutSpread(inputs.shortStrike, inputs.shortPremium, inputs.longStrike, inputs.longPremium, inputs.quantity, expirationPrice);
                strategyName = "Trava de Alta";
                params = `Strikes: ${inputs.shortStrike.toFixed(2)}/${inputs.longStrike.toFixed(2)}`;
                credit = (inputs.shortPremium - inputs.longPremium) * 100 * inputs.quantity;
                break;
        }

        const tradeData = {
            strategyName,
            ticker: inputs.ticker,
            params,
            credit,
            profitLoss: results.profitLoss
        };

        tradeLog.push(tradeData);
        addTradeToTable(tradeData);
        saveTrades();
        updateTotalPnl();
    }

    // --- INICIALIZAÇÃO E EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        const ctx = document.getElementById('payoff-chart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Lucro / Prejuízo (R$)',
                    data: [],
                    fill: false,
                    borderWidth: 2,
                    tension: 0.1,
                    pointRadius: 0,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        ticks: { color: '#9ca3af' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    x: {
                        ticks: { color: '#9ca3af', maxRotation: 0, minRotation: 0, autoSkip: true, maxTicksLimit: 10 },
                         grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `P/L: R$ ${parseFloat(context.raw).toFixed(2)}`;
                            },
                            title: function(context) {
                                return `Preço no Vencimento: R$ ${context[0].label}`;
                            }
                        }
                    }
                }
            }
        });
        
        const initialStockPrice = parseFloat(document.getElementById('cc-stock-price').value);
        updateSliderAndLabel(initialStockPrice);
        updateUI();
        loadTrades(); // Carrega as operações salvas ao iniciar

        document.querySelectorAll('input[type="number"], input[type="range"]').forEach(input => {
            input.addEventListener('input', updateUI);
        });
        
        document.querySelectorAll('input[id$="-stock-price"]').forEach(input => {
            input.addEventListener('change', (e) => {
                updateSliderAndLabel(parseFloat(e.target.value));
                updateUI();
            });
        });

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('tab-active'));
                tab.classList.add('tab-active');
                
                currentStrategy = tab.id.replace('tab-', '');
                
                forms.forEach(form => form.classList.add('hidden'));
                document.getElementById(`form-${currentStrategy}`).classList.remove('hidden');

                const prefix = getPrefix(currentStrategy);
                const stockPriceInput = document.getElementById(`${prefix}-stock-price`);
                if (stockPriceInput) {
                    updateSliderAndLabel(parseFloat(stockPriceInput.value));
                    updateUI();
                }
            });
        });

        logTradeBtn.addEventListener('click', logTrade);
        clearLogBtn.addEventListener('click', clearLog);
    });
    </script>
</body>
</html>
